# 프로젝트 시작하게 된 이유
나는 어느 날 교회 형에게 인터넷에 있는 네컷 사진을 찍는 프로그램을 
고등학생들이 제작하는 영상을 보여주며 만들어 줄 수 있냐는 제안을 받았다.
내가 보기에는 어려운 점은 보이지 않았다.
내가 이미 가지고 있는 지식은 
OpenCV를 통해 카메라를 제어 가능하고
프린터는 아마 다른 사람이 만들어둔 라이브러리가 있을 거라 생각했고
GUI는 Qt나 Flutter로 제작이 가능했기에 문제가 없었다.
그래서 만들겠다고 했다.

# 요구 사항
카메라와 연결해야한다고 했다.
그래서 카메라와 연결하면 웹캠처럼 쓸 수 있어야 한다. 라고 설명했다.
그래서 찾아보니 웹캠처럼 사용할 수 있는 방법이 있었다.
그래서 카메라를 사용하기로 했고

크기는 4\*6인치로 이루어진 포토용지다.
프레임은 내가 제작하지 않고 제작을 해줄 것이고
여러 개의 프레임을 선택할 수 있어야한다.
여기서는 각 프레임마다 입력해야 할 사진의 왼쪽 위 좌표, 오른쪽 아래 좌표를 작성하면
사진을 편집할 수 있을거라 생각했고 이는 JSON 파일로 작성하면 된다고 생각했다.
그래서 왼쪽 위 점, 오른쪽 아래 점을 찍을 수 있으면 된다고 했다.

프로젝트를 진행하다가 요구 사항이 추가로 발생했다.
사진을 찍을 때 사진에 스탬프처럼 찍히는 것을 원했다.
이거는 생각을 해보니 편집 프로그램에서 레이어를 나누듯
프레임 레이어, 사진 레이어, 오버레이 레이어로 구성해서
하나하나 덮어쓰기 하면 된다고 생각했다.


## 서비스 흐름
6개의 사진을 찍고 4개를 선택하고 프레임을 선택하면 편집해서 프린터로 출력하면 된다.

# 구상
프로젝트를 제작할 시간은 2달정도 된다.
프로젝트를 빠르게 제작하는게 좋을 거라 생각하여
가장 익숙한 언어인 파이썬을 통해
속도와 확장성을 통해 빠르고 다양한 기능을 한번에 제작 가능하게 만들려고 했다.

처음에 생각한 방식은 카메라를 제어할 때 내가 가지고 있는 미니 컨트롤러를 통해 
키보드 조작을 하여 카메라를 찍고

파이썬으로 제작한 GUI 앱, Flask 웹 서버, Flutter를 사용한 앱을 제작하여
GUI 앱과 웹 서버는 웹 소켓으로 연결되고
웹 서버와 Flutter 앱은 Post를 통해 서로 통신하면 된다고 생각했고

GUI 앱에서 사진을 찍으면 이미지를 파일로 저장하고 
웹 서버로 사진을 다 찍었다는 신호를 보내면

사진을 Flutter 앱으로 조회가 가능해지고
사진을 선택한 후 선택한 이미지를 서버로 보내서
서버에서 웹소켓을 통해 GUI 앱에게 선택을 다 했다는 신호와
선택한 이미지를 제공 받아서
이 이미지를 바탕으로 편집을 할 생각을 했다.

근데 이 아이디어는 통과되지는 않았고
마우스로 사진을 클릭해서 선택하는 방식으로 정했다.
따라서 PyQt6를 통해 GUI를 구현하고
프린터기와는 win32print, win32ui를 통해 연결해서 출력하고
사진 편집으로는 OpenCV-python 모듈을 사용해서 편집하려고 했다.

일단 요구 사항으로는
시작 화면,
몇 장을 출력 할지 정하는 화면,
사진을 찍는 화면,
사진을 어느 프레임에 편집할지 고르는 화면,
사진을 프린터로 출력하면서 표시될 화면,
출력 완료되었으며 처음으로 돌아가게 하는 화면
을 만들면 되었다.

# 구현




# 발생한 오류
## 패키지 매니징을 하지 않아서 발생한 문제
실행시키는 노트북은 내가 가지고 있는 노트북이 아닌
교회 형의 노트북으로 돌려보려고 했는데
안타깝게도 실행시키니 코드의 위치를 찾지 못해 실행이 안되는 문제가 발생했다.

그래서 고친 방법은 main.py 파일을 프로젝트 폴더의 가장 상위로 변경했다.
그러자 어느정도 고쳐졌고

나중에 UV 모듈을 찾게 된 계기가 되었다.

## 운영체제가 다름에 따라 웹캠 프로그램 호환 문제
한번 내가 가지고 있는 맥북으로 변경해서 실행시켜보려고 했는데
카메라와 맥북과 연결해도 맥북에서 인식을 못하는 문제가 발생했다.

그래서 프로젝트는 맥북으로 실행시키지 않기로 했다.

## 얕은 복사 문제
이상하게 편집에 실패하는 문제가 발생했다.
분명 편집하기 전 크기를 조절해주는 기능을 만들었는데
크기가 맞지 않아 편집이 안된다는 것이었다.
그래서 크기를 계산하는 클래스의 값을 출력해보니 음수의 길이를 가지는 문제가 발생했는데
크기를 계산하는 클래스의 값은 프로젝트 전체 클래스에서 사용하기 위한 용도로 제작했다.
시작할 때는 한번 설정하고 변경할 생각이 없었다.
나중에는 변경된 값이 필요해 값을 변경했고 이게 그 다음 프레임에게도 영향을 미쳐서
연속적으로 크기의 값을 계산하다 보니 예상치 못한 값을 가지게 된 것이다.

그래서 깊은 복사를 하는 함수를 추가해 현재 프레임에게만 영향을 미치게 수정했다.

## 서브 스레드가 죽는 문제
PyQt에서 QThread를 통해 스레드를 분리할 수 있다.
서브스레드에서는 카메라에서 이미지를 가져오고 나서
편집을 하고 메인 스레드로 pyqtSignal을 통해 이미지를 전송하는데
pyqtSignal에서는 OpenCV에서 사용하는 Numpy 배열을 전송할 수 없다.
QImage를 전송이 가능한데 그러기 위해서는 변환 작업이 필요하다.
테스트 환경인 웹캠에서는 FHD로 이미지 크기가 상대적으로 작은 크기인데
실제 사용할 카메라는 그것 보다 더 높은 해상도이기 때문에
서브 스레드에서는 너무 과도한 연산인지 너무 많은 메모리를 가지고 있어서 그런지
죽어버렸다.

문제를 찾는 과정이 어려웠는데
PyQt에서는 오류가 발생해서 종료가 될 때
에러가 표현이 되지 않는데
어디에서 문제가 발생했는지를 확인하기 위해서
코드를 주석처리 해가면서 찾았다.

그래서 해결한 방법은
서브 스레드에 callback 함수를 넣어서 OpenCV를 통해 이미지를 가져오면 QImage로 변환하지 않고
Numpy 배열 상태로 callback 함수에 매개변수로 넣고 실행시켜 메인 스레드에서 편집하게 수정했다.
그러자 실행 중 서브 스레드가 죽어서 프로그램이 종료되는 문제가 발생하지 않게 되었다.
